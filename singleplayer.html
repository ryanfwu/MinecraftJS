<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="icon" href="./assets/img/favicon.png">
        <link rel="stylesheet" href="./css/game.css">
        <title>MinecraftJS | Singleplayer</title>
        <script src="https://cdn.babylonjs.com/babylon.max.js"></script> <!-- BABYLONJS -->
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script> <!-- JQUERY -->
        <script src="./js/perlin.js"></script> <!-- Perlin Noise -->
        <script src="./js/config.js"></script> <!-- Config -->
    </head>
    <body>
        <canvas id="canvas" onclick="this.requestPointerLock();"></canvas>
        <script>
            window.addEventListener('DOMContentLoaded', function(){
                var canvas = document.getElementById('canvas');
                var engine = new BABYLON.Engine(canvas, true);
                var walkplaying = false;
                
                var seed = Math.random();
                noise.seed(seed);
                console.log("[LOG] Creating world with seed " + seed);
                
                var perlinGenerate = function(x, z) {
                    var terrainGeneration = (Math.round (((noise.perlin2(x, z) + 1) * 63 / 2) + 1));
                    console.log("[LOG] Perlin noise generated with data " + terrainGeneration);
                    return terrainGeneration;
                };
                
                var generateChunk = function() {
                    var chunk = [];
                    for (var x = 1; x <= 16; x++) {
                        for (var z = 1; z <= 16; z++) {
                            var noiseGeneration = perlinGenerate(x, z);
                            for (var y = 1; y <= 64; y++) {
                                if (y <= noiseGeneration) {
                                    chunk.push(blockCodes.grass);
                                }
                                else {
                                    chunk.push(blockCodes.air);
                                }
                            }
                        }
                    }
                    console.log("[LOG] Chunk created");
                    return chunk;
                };
                
                var createScene = function(terrain) {
                    var scene = new BABYLON.Scene(engine);
                    scene.clearColor = new BABYLON.Color3(0.529, 0.808, 0.922);
                    scene.gravity = new BABYLON.Vector3(0, -9.81 / engine.getFps().toFixed(), 0);
                    scene.collisionsEnabled = true;
                    
                    var light = new BABYLON.PointLight("light", new BABYLON.Vector3(8, 150, 8), scene);
                    light.intensity = 0.5;
                    light.radius = 12;
                    
                    var camera = new BABYLON.UniversalCamera('camera', new BABYLON.Vector3(8, 70, 8), scene);
                    camera.setTarget(BABYLON.Vector3.Zero());
                    camera.applyGravity = true;
                    camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
                    camera.checkCollisions = true;
                    camera.attachControl(canvas,true);
                    camera.keysUp.push(87);
                    camera.keysDown.push(83);
                    camera.keysLeft.push(65);
                    camera.keysRight.push(68);
                    camera.sensibility = 0.01;
                    camera.inertia = 0;
                    camera.speed = 0.75;
                    
                    window.addEventListener("keyup", jumpCheck, false);
                    function jumpCheck(event) {
                        if (event.keyCode == 32) {
                            camera.position.y += 3;
                        }
                    }
                    
                    var faceUV = new Array(6);
                    for (var i = 0; i < 6; i++) {
                        faceUV[i] = new BABYLON.Vector4(i / 6, 0, (i + 1) / 6, 1);
                    }
                    
                    var stoneTexture = new BABYLON.Texture("./assets/textures/stone.png", scene);
                    var grassTexture = new BABYLON.Texture("./assets/textures/grass_block.png", scene);
                    var dirtTexture = new BABYLON.Texture("./assets/textures/dirt.png", scene);
                    var cobblestoneTexture = new BABYLON.Texture("./assets/textures/cobblestone.png", scene);
                    var planksTexture = new BABYLON.Texture("./assets/textures/planks.png", scene);
                    var logTexture = new BABYLON.Texture("./assets/textures/log.png", scene);
                    var bedrockTexture = new BABYLON.Texture("./assets/textures/bedrock.png", scene);
                    
                    for (var x = 1; x <= 16; x++) {
                        for (var z = 1; z <= 16; z++) {
                            for (var y = 1; y <= 64; y++) {
                                var block = BABYLON.MeshBuilder.CreateBox(("block-" + x + "-" + z + "-" + y), {size: 1, faceUV: faceUV, wrap: true}, scene);
                                block.position = new BABYLON.Vector3(x, y, z);
                                block.checkCollisions = true;
                                switch (terrain[256 * x + 16 * z + y]) {
                                    case (blockCodes.air):
                                        break;
                                    case (blockCodes.stone):
                                        block.diffuseTexture = stoneTexture;
                                        break;
                                    case (blockCodes.grass):
                                        block.diffuseTexture = grassTexture;
                                        break;
                                    case (blockCodes.dirt):
                                        block.diffuseTexture = dirtTexture;
                                        break;
                                    case (blockCodes.cobblestone):
                                        block.diffuseTexture = cobblestoneTexture;
                                        break;
                                    case (blockCodes.planks):
                                        block.diffuseTexture = planksTexture;
                                        break;
                                    case (blockCodes.log):
                                        block.diffuseTexture = logTexture;
                                        break;
                                    case (blockCodes.bedrock):
                                        block.diffuseTexture = bedrockTexture;
                                        break;
                                    default:
                                        block.diffuseTexture = grassTexture;
                                        console.log("[LOG] Unknown block ID " + terrain[256 * x + 16 * z + y] + " at " + x + " / " + y + " / " + z);
                                        break;
                                }
                                console.log("[LOG] Block rendered at " + x + " / " + y + " / " + z);
                            }
                        }
                    }
                    
                    var walk1 = new BABYLON.Sound("Walk1", "./assets/sounds/walk1.ogg", scene);
                    var walk2 = new BABYLON.Sound("Walk2", "./assets/sounds/walk2.ogg", scene);
                    var walk3 = new BABYLON.Sound("Walk3", "./assets/sounds/walk3.ogg", scene);
                    var walk4 = new BABYLON.Sound("Walk4", "./assets/sounds/walk4.ogg", scene);
                    var walk5 = new BABYLON.Sound("Walk5", "./assets/sounds/walk5.ogg", scene);
                    var walk6 = new BABYLON.Sound("Walk6", "./assets/sounds/walk6.ogg", scene);
                    
                    window.addEventListener("keydown", function(event) {
                        if ((event.keyCode == 87 || event.keyCode == 65) || (event.keyCode == 83 || event.keyCode == 68)) {
                            if (walkplaying == false) {
                                var walknumber = Math.floor(Math.random() * 6) + 1;
                                switch (walknumber) {
                                    case 1:
                                        walk1.play();
                                        break;
                                    case 2:
                                        walk2.play();
                                        break;
                                    case 3:
                                        walk3.play();
                                        break;
                                    case 4:
                                        walk4.play();
                                        break;
                                    case 5:
                                        walk5.play();
                                        break;
                                    case 6:
                                        walk6.play();
                                        break;
                                    default:
                                        walk1.play();
                                }
                                walkplaying = true;
                                setTimeout(function() {
                                    walkplaying = false;
                                }, 450);
                            }
                        }
                    });
                                            
                    var music = new BABYLON.Sound("Music", "./assets/sounds/music.mp3", scene, null, {loop: true, autoplay: true});
                    music.play();

                    return scene;
                };
                
                var terrain = generateChunk();
                console.log("[LOG] Terrain generated");
                
                var scene = createScene(terrain);
                
                engine.runRenderLoop(function(){
                    scene.render();
                });
                
                canvas.requestPointerLock = canvas.requestPointerLock || canvas.mozRequestPointerLock;
                canvas.requestPointerLock();
            });
        </script>
    </body>
</html>
